<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Defense IQ Trainer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM & Lucide Icons via Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Prevent pull-to-refresh on mobile */
        body {
            overscroll-behavior: none;
            touch-action: none;
        }
        /* Pulse animation for selected player */
        @keyframes pulse-ring {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        .animate-pulse-ring::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 100%;
            height: 100%;
            background-color: rgba(59, 130, 246, 0.5); /* blue-500 */
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            z-index: -1;
        }
        
        /* Pulse for tutorial target */
        @keyframes pulse-target {
            0% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
        }
        .animate-pulse-target {
            animation: pulse-target 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full flex justify-center"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Share2, RefreshCw, Trophy, Info, ChevronRight, Clipboard, HelpCircle, Hand, Lock, GraduationCap, PlayCircle } from 'lucide-react';

        /**
         * UTILITIES & CONSTANTS
         */

        const VIEW_HEIGHT = 75; 

        const toPct = (courtY) => (courtY / VIEW_HEIGHT) * 100 + '%';

        const getDistance = (x1, y1, x2, y2) => {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        };

        const getScoreForDistance = (distance) => {
            if (distance < 15) return 10;  // Perfect (Expanded from 5)
            if (distance < 35) return 5;   // Good (Expanded from 15)
            if (distance < 45) return 0;   // Okay (Expanded from 25)
            if (distance < 50) return -5;  // Poor (Expanded from 35)
            if (distance < 60) return -10; // Bad (Expanded from 45)
            return -20; // Way off
        };

        const ROLES = [
            { id: 1, role: "PG", name: "Point Guard (Chaser)" },
            { id: 2, role: "SG", name: "Shooting Guard (Wing)" },
            { id: 3, role: "SF", name: "Small Forward (Wing)" },
            { id: 4, role: "PF", name: "Power Forward (Post)" },
            { id: 5, role: "C",  name: "Center (Rim/Anchor)" }
        ];

        // TUTORIAL SCENARIOS
        const TUTORIAL_SCENARIOS = [
            {
                id: 'tut-1',
                name: "Basic Controls",
                ballPos: { x: 50, y: 65 }, // Top Key
                lockedIds: [2, 3, 4, 5],
                tips: { "2-3": "Great! Tapping a player then the court is faster than dragging." },
                zones: {
                    "2-3": [
                        { id: 1, x: 50, y: 50 } // Only target for Player 1
                    ]
                }
            },
            {
                id: 'tut-2',
                name: "The 2-3 Setup",
                ballPos: { x: 50, y: 65 }, // Top Key
                lockedIds: [], // All unlocked
                tips: { "2-3": "Perfect shape! Now you're ready for the real drills without the guides." },
                zones: {
                    "2-3": [
                        // Standard 2-3 formation
                        { id: 1, x: 40, y: 55 }, { id: 2, x: 60, y: 55 }, 
                        { id: 3, x: 20, y: 25 }, { id: 4, x: 80, y: 25 }, { id: 5, x: 50, y: 25 }
                    ]
                }
            }
        ];

        const SCENARIOS = [
            {
                id: 1,
                name: "Ball at Top of Key",
                ballPos: { x: 50, y: 65 },
                tips: {
                    "2-3": "In a 2-3, Guards (1 & 2) must pinch the high post (Elbows). Don't get split!",
                    "3-2": "Point (1) pressures ball. Wings (2 & 3) drop to elbows.",
                    "1-3-1": "Chaser (1) on ball. Center (5) MUST be high (Free Throw Line)."
                },
                zones: {
                    "2-3": [
                        { id: 1, x: 40, y: 55 }, { id: 2, x: 60, y: 55 }, 
                        { id: 3, x: 20, y: 25 }, { id: 4, x: 80, y: 25 }, { id: 5, x: 50, y: 25 }
                    ],
                    "3-2": [
                        { id: 1, x: 50, y: 55 }, 
                        { id: 2, x: 30, y: 45 }, { id: 3, x: 70, y: 45 },
                        { id: 4, x: 35, y: 20 }, { id: 5, x: 65, y: 20 }
                    ],
                    "1-3-1": [
                        { id: 1, x: 50, y: 58 }, 
                        { id: 2, x: 25, y: 45 }, { id: 3, x: 75, y: 45 },
                        { id: 5, x: 50, y: 42 },
                        { id: 4, x: 50, y: 15 }
                    ]
                }
            },
            {
                id: 2,
                name: "Ball on Right Wing",
                ballPos: { x: 85, y: 60 },
                tips: {
                    "2-3": "Strong side guard (2) takes ball. Weak guard (1) drops to elbow. Center (5) fronts post.",
                    "3-2": "Strong wing (3) takes ball. Point (1) denies return.",
                    "1-3-1": "Wing (3) takes ball. Chaser (1) denies top return. Warrior (4) creates trap."
                },
                zones: {
                    "2-3": [
                        { id: 2, x: 75, y: 50 }, { id: 1, x: 50, y: 45 },
                        { id: 4, x: 80, y: 30 }, { id: 5, x: 60, y: 25 }, { id: 3, x: 20, y: 25 }
                    ],
                    "3-2": [
                        { id: 3, x: 75, y: 50 }, { id: 1, x: 60, y: 55 },
                        { id: 2, x: 35, y: 40 }, { id: 5, x: 80, y: 25 }, { id: 4, x: 50, y: 25 }
                    ],
                    "1-3-1": [
                        { id: 3, x: 75, y: 55 }, { id: 1, x: 60, y: 65 },
                        { id: 5, x: 65, y: 40 }, { id: 4, x: 85, y: 20 }, { id: 2, x: 50, y: 30 }
                    ]
                }
            },
            {
                id: 3,
                name: "Ball in Right Corner",
                ballPos: { x: 92, y: 20 },
                tips: {
                    "2-3": "Weak spot! Forward (4) sprints to cover. Center (5) drops to block.",
                    "3-2": "Post (5) covers corner. Weak post (4) slides to rim. Wing (3) denies.",
                    "1-3-1": "Trap! Warrior (4) and Wing (3) trap corner. Center (5) denies pass out.",
                },
                zones: {
                    "2-3": [
                        { id: 4, x: 85, y: 25 }, { id: 5, x: 65, y: 20 },
                        { id: 2, x: 75, y: 40 }, { id: 3, x: 50, y: 20 }, { id: 1, x: 50, y: 50 }
                    ],
                    "3-2": [
                        { id: 5, x: 85, y: 25 }, { id: 4, x: 60, y: 20 },
                        { id: 3, x: 80, y: 45 }, { id: 1, x: 50, y: 45 }, { id: 2, x: 30, y: 30 }
                    ],
                    "1-3-1": [
                        { id: 4, x: 88, y: 25 }, { id: 3, x: 82, y: 35 },
                        { id: 5, x: 70, y: 25 }, { id: 1, x: 60, y: 50 }, { id: 2, x: 50, y: 20 }
                    ]
                }
            },
            {
                id: 4,
                name: "Ball Left Wing (Deep)",
                ballPos: { x: 15, y: 55 },
                tips: {
                    "2-3": "Forward (3) steps out. Guard (1) drops to elbow. Center (5) fronts post.",
                    "3-2": "Wing (2) takes ball. Point (1) gaps. Post (4) fronts.",
                    "1-3-1": "Wing (2) takes ball. Chaser (1) denies top. Center (5) fronts.",
                },
                zones: {
                    "2-3": [
                        { id: 3, x: 25, y: 45 }, { id: 1, x: 40, y: 40 },
                        { id: 2, x: 70, y: 40 }, { id: 5, x: 35, y: 25 }, { id: 4, x: 60, y: 25 }
                    ],
                    "3-2": [
                        { id: 2, x: 25, y: 50 }, { id: 1, x: 40, y: 55 },
                        { id: 3, x: 70, y: 40 }, { id: 4, x: 30, y: 25 }, { id: 5, x: 60, y: 25 }
                    ],
                    "1-3-1": [
                        { id: 2, x: 25, y: 50 }, { id: 1, x: 40, y: 60 },
                        { id: 5, x: 35, y: 35 }, { id: 4, x: 20, y: 20 }, { id: 3, x: 60, y: 30 }
                    ]
                }
            },
            {
                // FINAL BOSS
                id: 5,
                name: "Ball High Post (The Nail)",
                ballPos: { x: 50, y: 45 },
                tips: {
                    "2-3": "Emergency! Center (5) steps up. Forwards pinch tight. Guards dig.",
                    "3-2": "Center (5) steps up. Wings collapse. Collapse everyone.",
                    "1-3-1": "Center (5) plays 1-on-1. Warrior (4) cheats up. Wings pinch.",
                },
                zones: {
                    "2-3": [
                        { id: 5, x: 50, y: 35 }, { id: 3, x: 30, y: 25 },
                        { id: 4, x: 70, y: 25 }, { id: 1, x: 40, y: 50 }, { id: 2, x: 60, y: 50 }
                    ],
                    "3-2": [
                        { id: 4, x: 45, y: 35 }, { id: 5, x: 55, y: 35 },
                        { id: 1, x: 50, y: 60 }, { id: 2, x: 30, y: 45 }, { id: 3, x: 70, y: 45 }
                    ],
                    "1-3-1": [
                        { id: 5, x: 50, y: 38 }, { id: 1, x: 50, y: 60 },
                        { id: 2, x: 35, y: 45 }, { id: 3, x: 65, y: 45 }, { id: 4, x: 50, y: 20 }
                    ]
                }
            }
        ];

        function DefenseIQApp() {
            // GAME STATE
            const [isTutorial, setIsTutorial] = useState(true);
            const [tutorialIndex, setTutorialIndex] = useState(0);
            const [currentScenarioIndex, setCurrentScenarioIndex] = useState(0);
            const [currentZone, setCurrentZone] = useState("2-3");
            const [score, setScore] = useState(0);
            const [gameState, setGameState] = useState('playing'); // 'playing', 'review', 'complete'
            
            // FEEDBACK
            const [lastRoundScore, setLastRoundScore] = useState(0);
            const [feedbackText, setFeedbackText] = useState("");
            const [showLegend, setShowLegend] = useState(false);
            
            // INTERACTION
            const [selectedPlayerId, setSelectedPlayerId] = useState(null);
            
            // PLAYERS
            const [players, setPlayers] = useState([]);

            const courtRef = useRef(null);

            // Init
            useEffect(() => {
                const saved = localStorage.getItem('defenseIQScore');
                if (saved) setScore(parseInt(saved));
                
                // Start with Tutorial 1
                resetPositionsForTutorial(0);
            }, []);

            // --- INIT HELPERS ---

            const resetPositionsForTutorial = (index) => {
                setIsTutorial(true);
                setTutorialIndex(index);
                setGameState('playing');
                setCurrentZone("2-3");
                
                const tut = TUTORIAL_SCENARIOS[index];
                const lockedIds = tut.lockedIds || [];

                // Reset players to baseline
                setPlayers([1, 2, 3, 4, 5].map(id => {
                    if (lockedIds.includes(id)) {
                        // Dummy positions for locked players in tutorial 1 so they are out of the way or fixed
                        // For simplicity, we just put them on the bench or specific spots
                        return { id, x: 20 + (id * 10), y: 20, locked: true };
                    }
                    return { id, x: 40 + (id * 5), y: 8, locked: false };
                }));
                
                setSelectedPlayerId(null);
            };

            const resetPositions = (scenarioIdx, zoneName) => {
                setIsTutorial(false);
                
                // STRICT Progressive Difficulty Logic
                let lockedIds = [];
                
                if (scenarioIdx === 0) {
                    lockedIds = [2, 3, 4, 5];
                } else if (scenarioIdx === 1) {
                    lockedIds = [3, 4, 5];
                } else if (scenarioIdx === 2) {
                    lockedIds = [4, 5];
                }
                // Level 4 & 5: No locks.

                const scenario = SCENARIOS[scenarioIdx];
                const correctPositions = scenario.zones[zoneName];

                const newPlayers = [1, 2, 3, 4, 5].map(id => {
                    const correctPos = correctPositions.find(p => p.id === id);
                    
                    if (lockedIds.includes(id)) {
                        return { ...correctPos, locked: true };
                    } else {
                        // Default Start Position: UNDER THE BASKET (Baseline)
                        return { 
                            id, 
                            x: 40 + (id * 5), 
                            y: 8,             
                            locked: false 
                        };
                    }
                });

                setPlayers(newPlayers);
                setSelectedPlayerId(null);
            };

            // --- FLOW CONTROL ---

            const startRegularSeason = () => {
                setCurrentScenarioIndex(0);
                setCurrentZone("2-3");
                setScore(0);
                setGameState('playing');
                resetPositions(0, "2-3");
                localStorage.setItem('defenseIQScore', 0);
            };

            const nextScenario = () => {
                if (isTutorial) {
                    if (tutorialIndex < TUTORIAL_SCENARIOS.length - 1) {
                        // Go to next tutorial step
                        resetPositionsForTutorial(tutorialIndex + 1);
                    } else {
                        // Tutorial Complete -> Go to Game
                        startRegularSeason();
                    }
                    return;
                }

                if (currentScenarioIndex < SCENARIOS.length - 1) {
                    const nextIndex = currentScenarioIndex + 1;
                    const zones = ["2-3", "3-2", "1-3-1"];
                    const nextZone = zones[Math.floor(Math.random() * zones.length)];
                    
                    setCurrentScenarioIndex(nextIndex);
                    setCurrentZone(nextZone);
                    setGameState('playing');
                    
                    resetPositions(nextIndex, nextZone);
                } else {
                    setGameState('complete');
                }
            };

            const restartGame = () => {
                // Skip tutorial on restart
                startRegularSeason();
            };

            // --- INTERACTION ---

            const handlePlayerClick = (e, player) => {
                if (gameState !== 'playing') return;
                if (player.locked) return;

                e.stopPropagation(); 
                
                if (selectedPlayerId === player.id) {
                    setSelectedPlayerId(null);
                } else {
                    setSelectedPlayerId(player.id);
                }
            };

            const handleCourtClick = (e) => {
                if (gameState !== 'playing') return;
                if (selectedPlayerId === null) return;

                if (courtRef.current) {
                    const rect = courtRef.current.getBoundingClientRect();
                    const xPct = ((e.clientX - rect.left) / rect.width) * 100;
                    const yPct = ((e.clientY - rect.top) / rect.height) * 100;

                    const yCourt = (yPct / 100) * VIEW_HEIGHT;

                    const clampedX = Math.max(2, Math.min(98, xPct));
                    const clampedY = Math.max(2, Math.min(VIEW_HEIGHT - 2, yCourt));

                    setPlayers(prev => prev.map(p => 
                        p.id === selectedPlayerId ? { ...p, x: clampedX, y: clampedY } : p
                    ));
                    
                    setSelectedPlayerId(null);
                }
            };

            const submitRound = () => {
                setSelectedPlayerId(null);
                
                const scenario = isTutorial ? TUTORIAL_SCENARIOS[tutorialIndex] : SCENARIOS[currentScenarioIndex];
                const correctPositions = scenario.zones[currentZone];
                
                let roundScore = 0;
                
                players.forEach(p => {
                    // Only score unlocked players
                    if (!p.locked) {
                        const correct = correctPositions.find(cp => cp.id === p.id);
                        if (correct) { // Ensure target exists
                            const distance = getDistance(p.x, p.y, correct.x, correct.y);
                            roundScore += getScoreForDistance(distance);
                        }
                    }
                });

                setLastRoundScore(roundScore);
                setScore(prev => {
                    // Don't save tutorial score to permanent record
                    if(isTutorial) return 0;

                    const newScore = prev + roundScore;
                    localStorage.setItem('defenseIQScore', newScore);
                    return newScore;
                });
                
                setFeedbackText(scenario.tips[currentZone]);
                setGameState('review');
            };

            const copyResults = () => {
                const text = `ðŸ€ Defense IQ Rating: ${score > 0 ? '+' : ''}${score}\n${score > 30 ? 'Elite Defender' : 'Benchwarmer'} Status\n\nCan you beat my rating?`;
                navigator.clipboard.writeText(text);
                alert("Rating copied! Share it with the team.");
            };

            // --- RENDER HELPERS ---

            const currentScenario = isTutorial ? TUTORIAL_SCENARIOS[tutorialIndex] : SCENARIOS[currentScenarioIndex];
            const activePlayersCount = players.filter(p => !p.locked).length;

            return (
                <div className="flex flex-col items-center min-h-screen font-sans selection:bg-orange-200">
                    
                    {/* HEADER */}
                    <div className="w-full max-w-md bg-white p-4 shadow-sm border-b border-gray-200 sticky top-0 z-20">
                        <div className="flex justify-between items-center mb-2">
                            <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <Clipboard className="w-5 h-5" /> Defense IQ
                            </h1>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setShowLegend(!showLegend)}
                                    className="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 hover:bg-gray-200"
                                >
                                    <HelpCircle className="w-3 h-3" /> Roles
                                </button>
                                {!isTutorial && (
                                    <div className={`px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 ${score >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                        <Trophy className="w-3 h-3" /> {score > 0 ? '+' : ''}{score}
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {!isTutorial ? (
                            <React.Fragment>
                                <div className="flex gap-1 mb-1">
                                    {SCENARIOS.map((_, idx) => (
                                        <div 
                                            key={idx} 
                                            className={`h-1 flex-1 rounded-full ${idx <= currentScenarioIndex ? 'bg-orange-500' : 'bg-gray-200'}`}
                                        />
                                    ))}
                                </div>
                                <p className="text-xs text-gray-500 text-center flex justify-center gap-2">
                                    <span>Scenario {currentScenarioIndex + 1} of 5</span>
                                    <span className="text-gray-300">â€¢</span>
                                    <span className="text-orange-600 font-bold">{activePlayersCount} Active Player{activePlayersCount !== 1 && 's'}</span>
                                </p>
                            </React.Fragment>
                        ) : (
                            <div className="flex flex-col items-center">
                                <div className="bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full mb-1">
                                    ROOKIE CAMP {tutorialIndex + 1}/2
                                </div>
                                <p className="text-xs text-gray-500 font-semibold">{currentScenario.name}</p>
                            </div>
                        )}

                        {showLegend && (
                            <div className="mt-2 bg-gray-50 p-2 rounded text-xs border border-gray-200 grid grid-cols-2 gap-1">
                                {ROLES.map(r => (
                                    <div key={r.id} className="flex items-center gap-2">
                                        <span className="bg-blue-600 text-white w-4 h-4 rounded-full flex items-center justify-center text-[10px] font-bold">{r.id}</span>
                                        <span className="text-gray-600">{r.role}</span>
                                    </div>
                                ))}
                                <div className="col-span-2 text-center text-gray-400 italic mt-1">1-3-1: 1 is Chaser, 4 is Warrior</div>
                            </div>
                        )}
                    </div>

                    {/* GAME AREA */}
                    <div className="w-full max-w-md p-4 flex-grow flex flex-col items-center">
                        
                        {gameState !== 'complete' ? (
                            <React.Fragment>
                                <div className="bg-white p-4 rounded-lg shadow-sm w-full mb-4 text-center border border-gray-200">
                                    <span className="block text-xs uppercase tracking-wider text-gray-400 font-bold mb-1">Mission</span>
                                    <h2 className="text-2xl font-black text-gray-800 mb-1">{isTutorial ? "LEARNING THE ROPES" : `${currentZone} ZONE`}</h2>
                                    <p className="text-sm text-gray-600">Defend: <span className="font-semibold text-orange-600">{currentScenario.name}</span></p>
                                </div>

                                {/* WHITEBOARD / COURT */}
                                <div 
                                    ref={courtRef}
                                    onClick={handleCourtClick}
                                    className={`relative w-full aspect-[4/3] bg-white rounded-xl shadow-lg border-4 border-gray-800 overflow-hidden transition-colors ${selectedPlayerId ? 'cursor-crosshair border-blue-400 ring-2 ring-blue-200' : ''}`}
                                    style={{
                                        backgroundImage: 'radial-gradient(#e5e7eb 1px, transparent 1px)',
                                        backgroundSize: '20px 20px'
                                    }}
                                >
                                    {/* SPAWN AREA INDICATOR (Only playing state) */}
                                    {gameState === 'playing' && (
                                        <div className="absolute top-0 left-0 w-full h-[15%] bg-blue-50/50 border-b border-blue-100 flex items-start justify-center pt-1 z-0">
                                            <span className="text-[10px] uppercase font-bold text-blue-300 tracking-widest">Bench / Baseline</span>
                                        </div>
                                    )}

                                    {/* SVG COURT LINES */}
                                    <svg viewBox={`0 0 100 ${VIEW_HEIGHT}`} className="absolute inset-0 w-full h-full pointer-events-none opacity-40 z-10">
                                        <line x1="0" y1="98" x2="100" y2="98" stroke="black" strokeWidth="1" />
                                        <rect x="35" y="0" width="30" height="38" fill="none" stroke="black" strokeWidth="1" />
                                        <path d="M 35 38 A 15 15 0 0 0 65 38" fill="none" stroke="black" strokeWidth="1" strokeDasharray="4 4" />
                                        <path d="M 35 38 A 15 15 0 0 1 65 38" fill="none" stroke="black" strokeWidth="1" />
                                        <path d="M 10 0 L 10 15 A 40 40 0 0 0 90 15 L 90 0" fill="none" stroke="black" strokeWidth="1" />
                                        <line x1="45" y1="4" x2="55" y2="4" stroke="black" strokeWidth="1" />
                                        <circle cx="50" cy="7" r="1.5" stroke="black" strokeWidth="1" fill="none" />
                                    </svg>

                                    {/* OFFENSIVE BALL */}
                                    <div 
                                        className="absolute w-6 h-6 bg-orange-500 rounded-full flex items-center justify-center text-white text-xs shadow-sm transform -translate-x-1/2 -translate-y-1/2 z-10"
                                        style={{ left: `${currentScenario.ballPos.x}%`, top: toPct(currentScenario.ballPos.y) }}
                                    >
                                    </div>

                                    {/* GHOST TARGETS (REVIEW or TUTORIAL PLAY) */}
                                    {(gameState === 'review' || (isTutorial && gameState === 'playing')) && 
                                        currentScenario.zones[currentZone].map((pos) => (
                                            <div
                                                key={`ghost-${pos.id}`}
                                                className={`absolute w-12 h-12 rounded-full border-2 border-green-500 border-dashed flex items-center justify-center transform -translate-x-1/2 -translate-y-1/2 opacity-60 z-0 ${isTutorial && gameState === 'playing' ? 'animate-pulse-target' : ''}`}
                                                style={{ left: `${pos.x}%`, top: toPct(pos.y) }}
                                            >
                                                {/* In Tutorial, show a little green dot to guide them exactly */}
                                                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                                {isTutorial && <span className="absolute -bottom-5 text-[10px] font-bold text-green-700 bg-white/80 px-1 rounded">{pos.id}</span>}
                                            </div>
                                        ))
                                    }

                                    {/* PLAYERS */}
                                    {players.map((player) => {
                                        const correct = gameState === 'review' ? currentScenario.zones[currentZone].find(p => p.id === player.id) : null;
                                        const isSelected = selectedPlayerId === player.id;
                                        const isLocked = player.locked;

                                        return (
                                            <React.Fragment key={player.id}>
                                                {/* Line & Score Indicator */}
                                                {gameState === 'review' && correct && !isLocked && (
                                                    <React.Fragment>
                                                        <svg className="absolute inset-0 w-full h-full pointer-events-none z-0">
                                                            <line 
                                                                x1={`${player.x}`} y1={`${player.y}`} 
                                                                x2={`${correct.x}`} y2={`${correct.y}`} 
                                                                stroke={getDistance(player.x, player.y, correct.x, correct.y) < 25 ? "green" : "red"} 
                                                                strokeWidth="0.5" 
                                                                strokeDasharray="4 2"
                                                            />
                                                        </svg>
                                                        {/* Individual Score Pop-up */}
                                                        <div 
                                                            className={`absolute transform -translate-x-1/2 -translate-y-full mt-[-10px] text-xs font-bold ${getScoreForDistance(getDistance(player.x, player.y, correct.x, correct.y)) >= 0 ? 'text-green-600' : 'text-red-600'}`}
                                                            style={{ left: `${player.x}%`, top: toPct(player.y) }}
                                                        >
                                                            {getScoreForDistance(getDistance(player.x, player.y, correct.x, correct.y)) > 0 ? '+' : ''}
                                                            {getScoreForDistance(getDistance(player.x, player.y, correct.x, correct.y))}
                                                        </div>
                                                    </React.Fragment>
                                                )}

                                                <div
                                                    onClick={(e) => handlePlayerClick(e, player)}
                                                    className={`absolute w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg shadow-lg transform -translate-x-1/2 -translate-y-1/2 transition-all z-20
                                                        ${isLocked 
                                                            ? 'bg-blue-900 text-blue-200 cursor-default opacity-50 border-2 border-blue-800' 
                                                            : gameState === 'review' 
                                                                ? 'bg-gray-200 text-gray-500 border-2 border-gray-400 scale-75 cursor-default'
                                                                : isSelected 
                                                                    ? 'bg-blue-600 text-white border-2 border-white scale-110 shadow-xl animate-pulse-ring cursor-pointer' 
                                                                    : 'bg-blue-600 text-white border-2 border-white hover:scale-105 active:scale-95 cursor-pointer'
                                                        }`}
                                                    style={{ 
                                                        left: `${player.x}%`, 
                                                        top: toPct(player.y),
                                                    }}
                                                >
                                                    {isLocked ? <Lock className="w-4 h-4" /> : player.id}
                                                </div>
                                            </React.Fragment>
                                        );
                                    })}
                                </div>

                                {/* INSTRUCTIONS / FEEDBACK AREA */}
                                <div className="w-full mt-4">
                                    {gameState === 'playing' ? (
                                        <div className="bg-blue-50 border border-blue-100 p-4 rounded-lg flex items-start gap-3">
                                            {selectedPlayerId ? (
                                                 <>
                                                    <Hand className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                                                    <p className="text-sm text-blue-800">
                                                        {isTutorial 
                                                            ? "Match the player number to the flashing target." 
                                                            : `Moving Player ${selectedPlayerId}. Tap anywhere on the court to place.`}
                                                    </p>
                                                 </>
                                            ) : (
                                                <>
                                                    <Info className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                                                    <p className="text-sm text-blue-800">
                                                        {isTutorial 
                                                            ? (tutorialIndex === 0 ? "Tap Player 1 to select him." : "Move all players to their flashing spots.")
                                                            : activePlayersCount === 5 
                                                                ? "Tap a player to select, then tap the court to move." 
                                                                : `Move the ${activePlayersCount} active player${activePlayersCount > 1 ? 's' : ''} from the baseline.`
                                                        }
                                                    </p>
                                                </>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="bg-green-50 border border-green-200 p-4 rounded-lg animate-in slide-in-from-bottom-2 duration-300">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className={`font-bold text-lg ${lastRoundScore >= 0 ? 'text-green-800' : 'text-red-800'}`}>
                                                    Rating: {lastRoundScore > 0 ? '+' : ''}{lastRoundScore}
                                                </span>
                                                <span className="text-xs text-green-600 uppercase font-bold tracking-wide">Coach says:</span>
                                            </div>
                                            <p className="text-sm text-gray-700 italic border-l-4 border-green-500 pl-3 mb-2">
                                                "{feedbackText}"
                                            </p>
                                        </div>
                                    )}
                                </div>

                                <div className="w-full mt-4 pb-8">
                                    {gameState === 'playing' ? (
                                        <button 
                                            onClick={submitRound}
                                            className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-black active:scale-95 transition-all flex items-center justify-center gap-2"
                                        >
                                            Submit Defense <ChevronRight />
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={nextScenario}
                                            className="w-full bg-orange-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-orange-700 active:scale-95 transition-all flex items-center justify-center gap-2"
                                        >
                                            {(isTutorial && tutorialIndex === TUTORIAL_SCENARIOS.length - 1) ? "Start Regular Season" : "Next Drill"} <ChevronRight />
                                        </button>
                                    )}
                                </div>
                            </React.Fragment>
                        ) : (
                            /* COMPLETION SCREEN */
                            <div className="flex flex-col items-center justify-center h-full w-full py-10 animate-in zoom-in duration-300">
                                <Trophy className={`w-24 h-24 mb-6 drop-shadow-md ${score > 0 ? 'text-yellow-500' : 'text-gray-400'}`} />
                                <h2 className="text-3xl font-black text-gray-900 mb-2">Season Complete!</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 text-center w-full mb-6">
                                    <span className="block text-gray-500 text-sm uppercase font-bold tracking-wider mb-2">Net Defensive Rating</span>
                                    <span className={`block text-6xl font-black mb-2 ${score >= 0 ? 'text-orange-600' : 'text-red-600'}`}>
                                        {score > 0 ? '+' : ''}{score}
                                    </span>
                                    <span className="block text-sm text-gray-400">
                                        {score > 30 ? "Defensive Player of the Year!" : score > 0 ? "Solid Rotational Player" : "Needs work in the G-League"}
                                    </span>
                                </div>
                                
                                <button 
                                    onClick={copyResults}
                                    className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center gap-2 mb-3"
                                >
                                    <Share2 className="w-5 h-5" /> Copy Rating to Team Chat
                                </button>
                                
                                <button 
                                    onClick={restartGame}
                                    className="w-full bg-white text-gray-600 py-3 rounded-xl font-semibold border-2 border-gray-200 hover:bg-gray-50 flex items-center justify-center gap-2"
                                >
                                    <RefreshCw className="w-4 h-4" /> Try Again
                                </button>
                            </div>
                        )}
                    </div>
                    
                    <div className="w-full text-center py-4 text-xs text-gray-400 bg-white border-t border-gray-100">
                        Defense IQ Trainer v1.4 â€¢ Feature: Updated Scoring
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<DefenseIQApp />);
    </script>
</body>
</html>